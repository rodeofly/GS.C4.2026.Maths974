---
// src/pages/guide/[...slug].astro
import { getCollection } from 'astro:content';
import A4Layout from '../../layouts/A4.astro';
import Etiquette from '../../components/Etiquette.astro';

// üõ†Ô∏è R√âCUP√âRATION BASE URL
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

export async function getStaticPaths() {
  const entries = await getCollection('guide');
  return entries.map(entry => {
    let cleanSlug = entry.slug;
    if (cleanSlug === 'index') {
      cleanSlug = undefined;
    } else {
      cleanSlug = cleanSlug.replace(/\/index$/, '');
    }
    return {
      params: { slug: cleanSlug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { slug } = Astro.params;

// üõ†Ô∏è CORRECTION 1 : L'URL pour les favoris doit inclure la base
const etiquetteData = {
  slug: entry.slug.replace(/\/index$/, ''),
  title: entry.data.title,
  id: entry.data.id || '',
  niveau: entry.data.niveau || '',
  theme: entry.data.theme || '',
  url: `${base}/guide/${entry.slug.replace(/\/index$/, '')}/` // Ajout de ${base}
};

const isIndex = entry.id.endsWith('index.md') || entry.slug.endsWith('/index');
const allGuides = await getCollection('guide');

let directChildren = [];
let subfolders = [];
let IndexContent = null;
let hasIndexContent = false;

if (isIndex) {
  const currentSlug = slug || '';
  const slugDepth = currentSlug ? currentSlug.split('/').length : 0;

  directChildren = allGuides.filter(e => {
    const eSlug = e.slug === 'index' ? '' : e.slug.replace(/\/index$/, '');
    if (!eSlug.startsWith(currentSlug + (currentSlug ? '/' : ''))) return false;
    if (e.id.endsWith('index.md')) return false;
    const childDepth = eSlug.split('/').length;
    return childDepth === slugDepth + 1;
  }).sort((a, b) => a.id.localeCompare(b.id));

  const allDescendantIndices = allGuides.filter(e => {
    const eSlug = e.slug === 'index' ? '' : e.slug.replace(/\/index$/, '');
    if (eSlug === currentSlug) return false;
    if (currentSlug && !eSlug.startsWith(currentSlug + '/')) return false;
    if (!e.id.endsWith('index.md')) return false;
    return true;
  });

  subfolders = allDescendantIndices.filter(candidate => {
     const candidateSlug = candidate.slug === 'index' ? '' : candidate.slug.replace(/\/index$/, '');
     const hasParentInList = allDescendantIndices.some(other => {
        const otherSlug = other.slug === 'index' ? '' : other.slug.replace(/\/index$/, '');
        if (otherSlug === candidateSlug) return false;
        return candidateSlug.startsWith(otherSlug ? otherSlug + '/' : '');
     });
     return !hasParentInList;
  }).sort((a, b) => a.id.localeCompare(b.id));

  const rendered = await entry.render();
  IndexContent = rendered.Content;
  hasIndexContent = entry.body && entry.body.trim().length > 0;
}

// üõ†Ô∏è CORRECTION 2 : Les boutons retour doivent inclure la base
let parentUrl = `${base}/`; // Par d√©faut vers l'accueil (avec base)
let parentTitle = 'Accueil';

if (!isIndex) {
  const parts = slug.split('/');
  parts.pop();
  const parentSlug = parts.join('/');
  
  const parentEntry = allGuides.find(e => {
    const cleanEntrySlug = e.slug.replace(/\/index$/, '');
    return cleanEntrySlug === parentSlug && e.id.endsWith('index.md');
  });

  if (parentEntry) {
    parentUrl = `${base}/guide/${parentSlug}/`; // Ajout de ${base}
    parentTitle = parentEntry.data.sous_theme || parentEntry.data.title;
  } else if (slug) {
     parentUrl = `${base}/guide/`; // Ajout de ${base}
     parentTitle = 'Sommaire';
  }
}
---

<A4Layout 
  info={entry} 
  niveau={entry.data.niveau} 
  theme={entry.data.theme}
  title={entry.data.title}
  indexContent={hasIndexContent ? IndexContent : null}
>

  {!isIndex && (
    <div class="single-etiquette-view">
      <div class="toolbar">
        <a href={parentUrl} class="btn-tool btn-back">
          <span class="icon">‚¨Ö</span>
          <span class="text">Retour √† : {parentTitle}</span>
        </a>
        <button id="fav-btn" class="btn-tool btn-fav" aria-label="Ajouter aux favoris">
          <span class="icon">‚òÜ</span>
          <span class="text">Ajouter aux favoris</span>
        </button>
      </div>
      <div class="focus-container">
        <Etiquette entry={entry} />
      </div>
    </div>
  )}

  {isIndex && (
    <>
      {subfolders.length > 0 && (
        <div class="subthemes-grid">
          {subfolders.map(subfolder => (
            /* üõ†Ô∏è CORRECTION 3 : Lien des sous-th√®mes */
            <a href={`${base}/guide/${subfolder.slug.replace(/\/index$/, '')}/`} class="subtheme-card">
              <h3 class="subtheme-title">{subfolder.data.sous_theme || subfolder.data.title}</h3>
              {subfolder.data.objectif && <p class="subtheme-objectif">{subfolder.data.objectif}</p>}
            </a>
          ))}
        </div>
      )}
      {directChildren.map((child) => <Etiquette entry={child} />)}
    </>
  )}

</A4Layout>

{/* Le script JS reste identique, il utilise etiquetteData qu'on a corrig√© plus haut */}
<script define:vars={{ etiquetteData, isIndex }}>
  import('/src/utils/storage.js').then(({ Favoris, Historique }) => {
    if (!isIndex) Historique.add(etiquetteData);
    const favBtn = document.getElementById('fav-btn');
    if (favBtn) {
      const icon = favBtn.querySelector('.icon');
      const text = favBtn.querySelector('.text');
      const updateUI = () => {
        const isFav = Favoris.isFavori(etiquetteData.slug);
        if (isFav) {
          favBtn.classList.add('active');
          icon.textContent = '‚≠ê';
          text.textContent = 'Retirer des favoris';
        } else {
          favBtn.classList.remove('active');
          icon.textContent = '‚òÜ';
          text.textContent = 'Ajouter aux favoris';
        }
      };
      favBtn.addEventListener('click', () => {
        if (Favoris.isFavori(etiquetteData.slug)) {
          Favoris.remove(etiquetteData.slug);
        } else {
          Favoris.add(etiquetteData);
        }
        updateUI();
      });
      updateUI();
    }
  });
</script>

<style>
/* ... Tes styles CSS (inchang√©s) ... */
.single-etiquette-view { grid-column: 1 / -1; display: flex; flex-direction: column; gap: var(--space-6); max-width: 800px; margin: 0 auto; width: 100%; }
.toolbar { display: flex; gap: var(--space-4); flex-wrap: wrap; }
.btn-tool { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3) var(--space-5); background: white; border: 2px solid var(--color-gray-200); border-radius: var(--radius-lg); text-decoration: none; color: var(--color-gray-700); font-weight: var(--font-bold); transition: all var(--transition-base); cursor: pointer; font-size: var(--text-base); }
.btn-tool:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.btn-back:hover { border-color: var(--color-gray-400); background: var(--color-gray-50); }
.btn-fav { margin-left: auto; color: var(--color-guide-primary); }
.btn-fav:hover { border-color: var(--color-guide-primary); background: var(--color-guide-bg); }
.btn-fav.active { background: var(--color-guide-primary); color: white; border-color: var(--color-guide-primary); }
.subthemes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-6); grid-column: 1 / -1; }
.subtheme-card { background: white; border: 2px solid var(--color-guide-light); border-left-width: 6px; border-radius: var(--radius-xl); padding: var(--space-6); text-decoration: none; transition: all var(--transition-base); display: flex; flex-direction: column; gap: var(--space-3); }
.subtheme-card:hover { border-color: var(--color-guide-primary); box-shadow: var(--shadow-guide); transform: translateY(-4px); }
.subtheme-title { margin: 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--color-guide-primary); }
.subtheme-objectif { margin: 0; font-size: var(--text-sm); color: var(--color-gray-600); line-height: var(--leading-relaxed); }
@media (max-width: 640px) { .toolbar { flex-direction: column; } .btn-fav { margin-left: 0; width: 100%; justify-content: center; } }
</style>