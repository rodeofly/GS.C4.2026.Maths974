---
// src/pages/rapidos/[...slug].astro
import { getCollection } from 'astro:content';
import RapidoLayout from '../../layouts/RapidoLayout.astro';
import A4Layout from '../../layouts/A4.astro';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

export async function getStaticPaths() {
  const entries = await getCollection('rapidos');
  return entries.map(entry => ({
    params: { slug: entry.slug.replace(/\/index$/, '') === 'index' ? undefined : entry.slug.replace(/\/index$/, '') },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { slug } = Astro.params;
const isIndex = entry.id.endsWith('index.md');
const allRapidos = await getCollection('rapidos');

const currentSlug = slug || '';
const slugDepth = currentSlug ? currentSlug.split('/').length : 0;

// INITIALISATION GÃ‰NÃ‰RALE POUR Ã‰VITER LES REFERENCEERROR
let IndexContent = null;
let hasIndexContent = false;
let directChildren = [];
let subfolders = [];

if (isIndex) {
  const rendered = await entry.render();
  IndexContent = rendered.Content;
  hasIndexContent = !!(entry.body && entry.body.trim().length > 0);

  // Filtrage des dossiers 
  subfolders = allRapidos.filter(e => {
    const eSlug = e.slug.replace(/\/index$/, '');
    
    // ðŸ› ï¸ FIX : On ignore l'index racine et le dossier actuel
    if (!e.id.endsWith('index.md') || eSlug === 'index' || eSlug === currentSlug) return false;
    
    if (currentSlug && !eSlug.startsWith(currentSlug + '/')) return false;
    if (!currentSlug && eSlug.includes('/')) return false; 

    const parts = eSlug.split('/');
    return parts.length === slugDepth + (currentSlug ? 1 : 1);
  }).sort((a, b) => (a.data.title || '').localeCompare(b.data.title || ''));

  directChildren = allRapidos.filter(e => {
    const eSlug = e.slug.replace(/\/index$/, ''); 
    if (e.id.endsWith('index.md') || !eSlug.startsWith(currentSlug + (currentSlug ? '/' : ''))) return false;
    return eSlug.split('/').length === slugDepth + 1;
  });
}

let parentUrl = currentSlug.includes('/') ? `${base}/rapidos/${currentSlug.split('/').slice(0, -1).join('/')}/` : `${base}/rapidos/`;
---

{!isIndex && <RapidoLayout info={entry} parentUrl={parentUrl} />}

{isIndex && (
  <A4Layout 
    info={entry} 
    title={entry.data.title || "Rapidos"} 
    indexContent={hasIndexContent ? IndexContent : null}
  >
    <div class="rapido-menu-grid">
      {subfolders.map(folder => (
        <a href={`${base}/rapidos/${folder.slug.replace(/\/index$/, '')}/`} class="card folder-card">
          <div class="card-header">
            <span class="rapido-icon">ðŸ“‚</span>
            <span class="rapido-number">{folder.data.title}</span>
          </div>
        </a>
      ))}
      {directChildren.map(child => (
        <a href={`${base}/rapidos/${child.slug}/`} class="card rapido-card-link">
          <div class="card-header">
            <span class="rapido-icon">âš¡</span>
            <span class="rapido-number">Rapido {child.data.numero}</span>
          </div>
        </a>
      ))}
    </div>
  </A4Layout>
)}

<style>
  .rapido-menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-6);
    padding: var(--space-4) 0;
    grid-column: 1 / -1;
  }
  
  .card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-decoration: none;
    color: var(--color-gray-900);
    border: 2px solid var(--color-gray-100);
    transition: all var(--transition-base);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
  }

  .rapido-card-link:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-rapido-primary);
  }
  
  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  
  .rapido-icon { 
    font-size: var(--text-2xl);
    background: var(--color-rapido-light);
    color: var(--color-rapido-primary);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .rapido-number { 
    font-weight: var(--font-black);
    font-size: var(--text-lg);
    color: var(--color-gray-900);
  }

  .rapido-meta {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-gray-500);
    padding-left: calc(40px + var(--space-3));
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
  }
  
  .niveau-badge {
    color: var(--color-rapido-primary);
    font-weight: var(--font-bold);
  }

  .empty-msg {
    color: var(--color-gray-500);
    font-style: italic;
    grid-column: 1 / -1;
    text-align: center;
    padding: 2rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-lg);
  }
</style>