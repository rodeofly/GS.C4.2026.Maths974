---
// src/pages/rapidos/[...slug].astro
import { getCollection } from 'astro:content';
import RapidoLayout from '../../layouts/RapidoLayout.astro';
import A4Layout from '../../layouts/A4.astro';

// 1. RÃ©cupÃ©ration de la Base URL (pour GitHub Pages)
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

export async function getStaticPaths() {
  const entries = await getCollection('rapidos');
  return entries.map(entry => {
    let cleanSlug = entry.slug.replace(/\/index$/, '');
    if (cleanSlug === 'index') {
        cleanSlug = undefined;
    }
    return {
      params: { slug: cleanSlug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { slug } = Astro.params;

const isIndex = entry.id.endsWith('index.md');

// Logique pour trouver le parent valide (pour le bouton retour)
const allRapidos = await getCollection('rapidos');

// ðŸ› ï¸ CORRECTION 1 : Le parent par dÃ©faut doit inclure la base
let parentUrl = `${base}/rapidos/`; 

if (!isIndex) {
  const parts = entry.slug.split('/');
  parts.pop(); 
  while (parts.length > 0) {
    const candidateSlug = parts.join('/');
    const parentEntry = allRapidos.find(e => {
        const eSlug = e.slug.replace(/\/index$/, '');
        return eSlug === candidateSlug && e.id.endsWith('index.md');
    });
    if (parentEntry) {
      // ðŸ› ï¸ CORRECTION 2 : Le lien parent calculÃ© doit inclure la base
      parentUrl = `${base}/rapidos/${candidateSlug}/`;
      break; 
    }
    parts.pop(); 
  }
}

let directChildren = [];
let subfolders = [];

if (isIndex) {
  const currentSlug = slug || '';
  const slugDepth = currentSlug ? currentSlug.split('/').length : 0;

  // 1. RÃ©cupÃ©rer les fichiers rituels du dossier actuel (profondeur + 1)
  directChildren = allRapidos.filter(e => {
    const eSlug = e.slug.replace(/\/index$/, '');
    if (!eSlug.startsWith(currentSlug + (currentSlug ? '/' : ''))) return false;
    if (e.id.endsWith('index.md')) return false;
    const childDepth = eSlug.split('/').length;
    return childDepth === slugDepth + 1;
  }).sort((a, b) => (a.data.numero || '').localeCompare(b.data.numero || ''));

  // 2. RÃ©cupÃ©rer les sous-dossiers (fichiers index.md Ã  profondeur + 1)
  subfolders = allRapidos.filter(e => {
    const eSlug = e.slug.replace(/\/index$/, '');
    if (eSlug === currentSlug) return false;
    if (!eSlug.startsWith(currentSlug + (currentSlug ? '/' : ''))) return false;
    if (!e.id.endsWith('index.md')) return false;
    const childDepth = eSlug.split('/').length;
    return childDepth === slugDepth + 1;
  }).sort((a, b) => a.data.title.localeCompare(b.data.title));
}

let children = [];
if (isIndex) {
  const prefix = slug ? slug + '/' : '';
  children = allRapidos
    .filter(e => {
        if (e.id.endsWith('index.md')) return false;
        return e.slug.startsWith(prefix);
    })
    .sort((a, b) => a.id.localeCompare(b.id));
}

const { Content: IndexContent } = await entry.render();
const hasIndexContent = isIndex && entry.body && entry.body.trim().length > 0;
---

{/* CAS 1 : Fiche Rapido */}
{!isIndex && <RapidoLayout info={entry} parentUrl={parentUrl} />}

{/* CAS 2 : Menu / Index */}
{isIndex && (
  <A4Layout ...>
    <div class="rapido-menu-grid">
      {/* AFFICHAGE DES DOSSIERS (CatÃ©gories) */}
      {subfolders.map(folder => (
        <a href={`${base}/rapidos/${folder.slug.replace(/\/index$/, '')}/`} class="card folder-card">
          <div class="card-header">
            <span class="folder-icon">ðŸ“‚</span>
            <h3>{folder.data.title}</h3>
          </div>
          {folder.data.niveau && <span class="badge">{folder.data.niveau}</span>}
        </a>
      ))}

      {/* AFFICHAGE DES RAPIDOS DIRECTS */}
      {directChildren.map(child => (
        <a href={`${base}/rapidos/${child.slug}/`} class="card rapido-card-link">
          {/* ... contenu de la carte existant (badge numero, meta) ... */}
        </a>
      ))}
    </div>
  </A4Layout>
)}

<style>
  .rapido-menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-6);
    padding: var(--space-4) 0;
    grid-column: 1 / -1;
  }
  
  .card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-decoration: none;
    color: var(--color-gray-900);
    border: 2px solid var(--color-gray-100);
    transition: all var(--transition-base);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
  }

  .rapido-card-link:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-rapido-primary);
  }
  
  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  
  .rapido-icon { 
    font-size: var(--text-2xl);
    background: var(--color-rapido-light);
    color: var(--color-rapido-primary);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .rapido-number { 
    font-weight: var(--font-black);
    font-size: var(--text-lg);
    color: var(--color-gray-900);
  }

  .rapido-meta {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-gray-500);
    padding-left: calc(40px + var(--space-3));
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
  }
  
  .niveau-badge {
    color: var(--color-rapido-primary);
    font-weight: var(--font-bold);
  }

  .empty-msg {
    color: var(--color-gray-500);
    font-style: italic;
    grid-column: 1 / -1;
    text-align: center;
    padding: 2rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-lg);
  }
</style>