---
// src/pages/rapidos/[...slug].astro
import { getCollection } from 'astro:content';
import RapidoLayout from '../../layouts/RapidoLayout.astro';
import A4Layout from '../../layouts/A4.astro';

// 1. R√©cup√©ration de la Base URL (pour GitHub Pages)
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

export async function getStaticPaths() {
  const entries = await getCollection('rapidos');
  return entries.map(entry => {
    let cleanSlug = entry.slug.replace(/\/index$/, '');
    if (cleanSlug === 'index') {
        cleanSlug = undefined;
    }
    return {
      params: { slug: cleanSlug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { slug } = Astro.params;

const isIndex = entry.id.endsWith('index.md');

// Logique pour trouver le parent valide (pour le bouton retour)
const allRapidos = await getCollection('rapidos');

// üõ†Ô∏è CORRECTION 1 : Le parent par d√©faut doit inclure la base
let parentUrl = `${base}/rapidos/`; 

if (!isIndex) {
  const parts = entry.slug.split('/');
  parts.pop(); 
  while (parts.length > 0) {
    const candidateSlug = parts.join('/');
    const parentEntry = allRapidos.find(e => {
        const eSlug = e.slug.replace(/\/index$/, '');
        return eSlug === candidateSlug && e.id.endsWith('index.md');
    });
    if (parentEntry) {
      // üõ†Ô∏è CORRECTION 2 : Le lien parent calcul√© doit inclure la base
      parentUrl = `${base}/rapidos/${candidateSlug}/`;
      break; 
    }
    parts.pop(); 
  }
}

let children = [];
if (isIndex) {
  const prefix = slug ? slug + '/' : '';
  children = allRapidos
    .filter(e => {
        if (e.id.endsWith('index.md')) return false;
        return e.slug.startsWith(prefix);
    })
    .sort((a, b) => a.id.localeCompare(b.id));
}

const { Content: IndexContent } = await entry.render();
const hasIndexContent = isIndex && entry.body && entry.body.trim().length > 0;
---

{/* CAS 1 : Fiche Rapido */}
{!isIndex && <RapidoLayout info={entry} parentUrl={parentUrl} />}

{/* CAS 2 : Menu / Index */}
{isIndex && (
  <A4Layout 
    info={entry} 
    title={entry.data.title || "Rapidos"} 
    theme="Rapidos"
    indexContent={hasIndexContent ? IndexContent : null}
  >
    <div class="rapido-menu-grid">
      {children.length > 0 ? children.map(child => (
        
        /* üõ†Ô∏è CORRECTION 3 : Ajout de la base dans le lien de la carte */
        <a href={`${base}/rapidos/${child.slug}/`} class="card rapido-card-link">
          
          <div class="card-header">
            <span class="rapido-icon">‚ö°</span>
            <span class="rapido-number">Rapido {child.data.numero}</span>
          </div>
          
          <div class="rapido-meta">
            {child.data.questions && (
               <span>{child.data.questions.length} questions</span>
            )}
            {child.data.semaine && (
               <span>‚Ä¢ Semaine {child.data.semaine}</span>
            )}
            {child.data.niveau && (
               <span class="niveau-badge">‚Ä¢ {child.data.niveau}</span>
            )}
          </div>

        </a>
      )) : (
        <div class="empty-msg">Aucun rapido disponible pour le moment.</div>
      )}
    </div>
  </A4Layout>
)}

<style>
  .rapido-menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-6);
    padding: var(--space-4) 0;
    grid-column: 1 / -1;
  }
  
  .card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-decoration: none;
    color: var(--color-gray-900);
    border: 2px solid var(--color-gray-100);
    transition: all var(--transition-base);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
  }

  .rapido-card-link:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-rapido-primary);
  }
  
  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  
  .rapido-icon { 
    font-size: var(--text-2xl);
    background: var(--color-rapido-light);
    color: var(--color-rapido-primary);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .rapido-number { 
    font-weight: var(--font-black);
    font-size: var(--text-lg);
    color: var(--color-gray-900);
  }

  .rapido-meta {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-gray-500);
    padding-left: calc(40px + var(--space-3));
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
  }
  
  .niveau-badge {
    color: var(--color-rapido-primary);
    font-weight: var(--font-bold);
  }

  .empty-msg {
    color: var(--color-gray-500);
    font-style: italic;
    grid-column: 1 / -1;
    text-align: center;
    padding: 2rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-lg);
  }
</style>