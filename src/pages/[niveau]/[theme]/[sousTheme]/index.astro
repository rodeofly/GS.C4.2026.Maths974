---
import A4Layout from '../../../../layouts/A4.astro';
import Etiquette from '../../../../components/Etiquette.astro';

export async function getStaticPaths() {
  const infoEntries = await Astro.glob('../../../../../content/*/*/*/index.md');

  return infoEntries.map((info) => {
    const match = info.file.match(/\/content\/([^/]+)\/([^/]+)\/([^/]+)\/index\.md$/);

    if (!match) {
      throw new Error(`Impossible d'extraire les paramètres depuis le chemin ${info.file}`);
    }

    const [, niveau, theme, sousTheme] = match;

    return {
      params: { niveau, theme, sousTheme },
    };
  });
}

const { niveau, theme, sousTheme } = Astro.params;
const contentPathSegment = `/content/${niveau}/${theme}/${sousTheme}/`;
const infoEntries = await Astro.glob('../../../../../content/*/*/*/index.md');
const info = infoEntries.find((entry) => entry.file.includes(contentPathSegment));

if (!info) {
  throw new Error(`Aucun fichier index.md trouvé pour le sous-thème ${niveau}/${theme}/${sousTheme}`);
}

const etiquettesRaw = await Astro.glob('../../../../../content/*/*/*/*.md');
const etiquettes = etiquettesRaw
  .filter((item) => item.file.includes(contentPathSegment) && !item.file.endsWith('/index.md'))
  .sort((a, b) => a.file.localeCompare(b.file, 'fr'));
---
<A4Layout info={info} niveau={niveau} theme={theme} sousTheme={sousTheme}>
  {etiquettes.map((entry) => (
    <Etiquette entry={entry} />
  ))}
</A4Layout>
