---
// src/pages/[niveau]/[theme]/[sousTheme]/index.astro
import { getCollection } from 'astro:content';
import A4Layout from '../../../../layouts/A4.astro';
import Etiquette from '../../../../components/Etiquette.astro';

export async function getStaticPaths() {
  const allEntries = await getCollection('guide');
  
  // On récupère uniquement les fichiers "index.md" qui définissent les sous-thèmes
  const sousThemeIndices = allEntries.filter((entry) => entry.slug.endsWith('/index'));

  return sousThemeIndices.map((entry) => {
    // Le slug ressemble à "terminale/analyse/limites/index"
    // On le découpe pour récupérer les paramètres
    const parts = entry.slug.split('/');
    // parts = ['terminale', 'analyse', 'limites', 'index']
    
    if (parts.length < 4) return null;
    
    const [niveau, theme, sousTheme] = parts;

    return {
      params: { niveau, theme, sousTheme },
      props: { info: entry },
    };
  }).filter(Boolean);
}

const { niveau, theme, sousTheme } = Astro.params;
const { info } = Astro.props;

// Récupérer toutes les fiches qui appartiennent à ce sous-thème
// C'est-à-dire celles dont le slug commence par "niveau/theme/sousTheme/"
const baseSlug = `${niveau}/${theme}/${sousTheme}/`;

const allEntries = await getCollection('guide');
const etiquettes = allEntries
  .filter((entry) => entry.slug.startsWith(baseSlug) && !entry.slug.endsWith('/index'))
  .sort((a, b) => a.id.localeCompare(b.id)); // ou trier par nom de fichier si pas d'ID

// Note : Avec les Content Collections, le contenu Markdown est rendu via <Content />
// mais il faut d'abord le "rendre".
// Dans la boucle map plus bas, on passera l'objet 'entry' directement au composant Etiquette.
// Il faudra adapter légèrement Etiquette.astro (voir étape 4).
---

<A4Layout info={info} niveau={niveau} theme={theme} sousTheme={sousTheme}>
  {etiquettes.map((entry) => (
    <Etiquette entry={entry} />
  ))}
</A4Layout>