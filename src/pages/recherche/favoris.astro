---
// src/pages/recherche/favoris.astro
import Navbar from '../../components/Navbar.astro';
import '../../styles/main.css';

// 1. R√©cup√©ration de la Base URL pour GitHub Pages
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Favoris & Historique - Maths974</title>
  <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
</head>
<body>
  
  <Navbar title="Favoris" />

  <main class="page-container">
    
    <header class="page-header">
      <h1>Mes Favoris & Historique</h1>
      <p>Retrouvez vos fiches sauvegard√©es et vos derni√®res consultations.</p>
    </header>
    
    <div class="tabs">
      <button class="tab-btn active" data-tab="favoris">
        ‚≠ê Favoris <span class="tab-badge" id="favorisCount">0</span>
      </button>
      <button class="tab-btn" data-tab="historique">
        üïê Historique <span class="tab-badge" id="historiqueCount">0</span>
      </button>
      
      {/* 2. CORRECTION DU LIEN RECHERCHE */}
      <a href={`${base}/recherche/`} class="tab-btn" style="text-decoration:none;">
        üîç Recherche
      </a>
    </div>
    
    <div class="tab-panel active" id="panel-favoris">
      <div class="actions-bar">
        <span class="stats-count"><strong id="favorisTotal">0</strong> √©l√©ments</span>
        <button class="action-btn danger" id="clearFavoris">üóëÔ∏è Vider les favoris</button>
      </div>
      
      <div class="results-grid" id="favorisList"></div>
      
      <div class="empty-state" id="emptyFavoris">
        <span class="empty-icon">‚≠ê</span>
        <h2 class="empty-title">Aucun favori pour le moment</h2>
        <p class="empty-text">Ajoutez des fiches en favoris lors de votre navigation.</p>
        
        {/* 3. CORRECTION DU BOUTON PARCOURIR */}
        <a href={`${base}/recherche/`} class="btn-cta">Parcourir les fiches</a>
      </div>
    </div>
    
    <div class="tab-panel" id="panel-historique">
      <div class="actions-bar">
        <span class="stats-count"><strong id="historiqueTotal">0</strong> consult√©s r√©cemment</span>
        <button class="action-btn danger" id="clearHistorique">üóëÔ∏è Effacer l'historique</button>
      </div>
      
      <div class="results-grid" id="historiqueList"></div>
      
      <div class="empty-state" id="emptyHistorique">
        <span class="empty-icon">üïê</span>
        <h2 class="empty-title">Historique vide</h2>
        <p class="empty-text">Vos derni√®res consultations appara√Ætront ici.</p>
        
        {/* 4. CORRECTION DU BOUTON ACCUEIL */}
        <a href={`${base}/`} class="btn-cta">Aller √† l'accueil</a>
      </div>
    </div>
    
  </main>
  
  {/* 5. CORRECTION DU SCRIPT : Import relatif g√©r√© par Astro */}
  <script>
    import { Favoris, Historique } from '../../utils/storage.js';

    // UI Logic
    const tabs = document.querySelectorAll('.tab-btn[data-tab]');
    const panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = (tab as HTMLElement).dataset.tab; // Cast TS simple ou enlever le type si pur JS
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        panels.forEach(p => p.classList.remove('active'));
        document.getElementById(`panel-${target}`)?.classList.add('active');
      });
    });

    // Helper functions
    function formatDate(isoDate) {
      if(!isoDate) return '';
      const date = new Date(isoDate);
      return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    }

    function createCard(etiq, showRemove = true, dateField = null) {
      const card = document.createElement('a');
      card.href = etiq.url; // L'URL est d√©j√† stock√©e avec le bon chemin dans storage.js normalement
      card.className = 'result-card';
      
      let removeBtnHTML = '';
      if (showRemove) {
        removeBtnHTML = `<button class="card-remove" data-remove="${etiq.slug}" title="Retirer">√ó</button>`;
      }
      
      const dateHTML = (dateField && etiq[dateField]) 
        ? `<div style="font-size:0.8em; color:#64748b; margin-top:5px;">Vu le ${formatDate(etiq[dateField])}</div>` 
        : '';

      card.innerHTML = `
        ${removeBtnHTML}
        <div class="card-header">
           ${etiq.id ? `<span class="card-id">${etiq.id}</span>` : ''}
        </div>
        <h3 class="card-title">${etiq.title}</h3>
        <div class="card-tags">
             ${etiq.niveau ? `<span class="card-tag">${etiq.niveau}</span>` : ''}
             ${etiq.theme ? `<span class="card-tag">${etiq.theme}</span>` : ''}
        </div>
        ${dateHTML}
      `;
      return card;
    }

    // Logic for Favoris
    function displayFavoris() {
      const favoris = Favoris.getAll();
      const container = document.getElementById('favorisList');
      const empty = document.getElementById('emptyFavoris');
      
      const countEl = document.getElementById('favorisCount');
      const totalEl = document.getElementById('favorisTotal');
      if(countEl) countEl.textContent = favoris.length.toString();
      if(totalEl) totalEl.textContent = favoris.length.toString();
      
      if(container) container.innerHTML = '';
      
      if (favoris.length === 0) {
        if(empty) empty.style.display = 'block';
        return;
      }
      if(empty) empty.style.display = 'none';
      
      favoris.forEach(fav => {
        const card = createCard(fav, true, 'addedAt');
        if(container) container.appendChild(card);
        
        // Handle click on remove button
        const btn = card.querySelector('[data-remove]');
        if(btn) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                Favoris.remove(fav.slug);
                displayFavoris();
            });
        }
      });
    }

    // Logic for Historique
    function displayHistorique() {
      const hist = Historique.getAll();
      const container = document.getElementById('historiqueList');
      const empty = document.getElementById('emptyHistorique');
      
      const countEl = document.getElementById('historiqueCount');
      const totalEl = document.getElementById('historiqueTotal');
      if(countEl) countEl.textContent = hist.length.toString();
      if(totalEl) totalEl.textContent = hist.length.toString();
      
      if(container) container.innerHTML = '';
      
      if (hist.length === 0) {
        if(empty) empty.style.display = 'block';
        return;
      }
      if(empty) empty.style.display = 'none';
      
      hist.forEach(item => {
        const card = createCard(item, false, 'visitedAt');
        if(container) container.appendChild(card);
      });
    }

    const btnClearFav = document.getElementById('clearFavoris');
    if(btnClearFav) {
        btnClearFav.addEventListener('click', () => {
            if(confirm('Tout supprimer ?')) { Favoris.clear(); displayFavoris(); }
        });
    }

    const btnClearHist = document.getElementById('clearHistorique');
    if(btnClearHist) {
        btnClearHist.addEventListener('click', () => {
            if(confirm('Tout effacer ?')) { Historique.clear(); displayHistorique(); }
        });
    }

    // Init
    displayFavoris();
    displayHistorique();
  </script>
</body>
</html>