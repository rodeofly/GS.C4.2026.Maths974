---
// src/pages/recherche/index.astro
import '../../styles/main.css';
import { getCollection } from 'astro:content';

// R√©cup√©rer TOUTES les √©tiquettes (pas les index)
const allEtiquettes = await getCollection('guide', ({ id }) => {
  return !id.endsWith('index.md');
});

// R√©cup√©rer tous les index pour avoir les infos de sous-th√®mes
const allIndex = await getCollection('guide', ({ id }) => {
  return id.endsWith('index.md');
});

// Pr√©parer les donn√©es pour le JS client
const etiquettesData = allEtiquettes.map(e => {
  const { data } = e;
  
  // Trouver le sous-th√®me parent
  const sousThemeSlug = e.slug.substring(0, e.slug.lastIndexOf('/'));
  const sousTheme = allIndex.find(idx => idx.slug === sousThemeSlug);
  
  return {
    id: data.id || e.slug,
    title: data.title,
    slug: e.slug,
    niveau: data.niveau || sousTheme?.data.niveau,
    theme: data.theme || sousTheme?.data.theme,
    sous_theme: data.sous_theme || sousTheme?.data.sous_theme,
    tags: data.tags || [],
    competences: data.competences || [],
    format: data.format || '1/1',
    contenus: data.contenus || [],
    url: `/guide/${e.slug}/`
  };
});

// Extraire tous les tags uniques
const allTags = [...new Set(etiquettesData.flatMap(e => e.tags))].sort();

// Extraire tous les niveaux uniques
const allNiveaux = [...new Set(etiquettesData.map(e => e.niveau).filter(Boolean))].sort();

// Extraire tous les th√®mes uniques
const allThemes = [...new Set(etiquettesData.map(e => e.theme).filter(Boolean))].sort();
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recherche - Maths974</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  
  <style>
    /* Styles sp√©cifiques √† la page de recherche */
    .search-page {
      min-height: 100vh;
      padding: var(--space-4);
    }
    
    .search-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Header avec logo et recherche */
    .search-header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-xl);
    }
    
    .search-brand {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }
    
    .search-brand a {
      text-decoration: none;
      color: white;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .logo-974 {
      background: var(--color-accent);
      color: #1e293b;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-weight: var(--font-black);
    }
    
    .brand-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-black);
    }
    
    /* Barre de recherche */
    .search-input-wrapper {
      position: relative;
      margin-bottom: var(--space-4);
    }
    
    .search-input {
      width: 100%;
      padding: var(--space-4) var(--space-6);
      padding-left: 3.5rem;
      font-size: var(--text-lg);
      border: 2px solid transparent;
      border-radius: var(--radius-xl);
      background: white;
      transition: all var(--transition-base);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      font-size: var(--text-2xl);
      color: var(--color-gray-400);
    }
    
    /* Filtres */
    .filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
    }
    
    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      align-items: center;
    }
    
    .filter-label {
      color: white;
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.9;
    }
    
    .filter-tag {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: var(--text-sm);
      user-select: none;
    }
    
    .filter-tag:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .filter-tag.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      font-weight: var(--font-bold);
    }
    
    /* Stats */
    .search-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);
      background: white;
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
    }
    
    .stats-count {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-gray-700);
    }
    
    .stats-count strong {
      color: var(--color-guide-primary);
      font-size: var(--text-2xl);
    }
    
    .clear-filters {
      padding: var(--space-2) var(--space-4);
      background: transparent;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      color: var(--color-gray-600);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .clear-filters:hover {
      background: var(--color-gray-100);
      border-color: var(--color-gray-400);
    }
    
    /* Grille de r√©sultats */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--space-4);
    }
    
    .etiquette-card {
      background: white;
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      text-decoration: none;
      color: inherit;
      transition: all var(--transition-base);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .etiquette-card:hover {
      border-color: var(--color-guide-primary);
      box-shadow: var(--shadow-guide);
      transform: translateY(-4px);
    }
    
    .card-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .card-id {
      display: inline-block;
      background: linear-gradient(135deg, var(--color-guide-primary), var(--color-guide-secondary));
      color: white;
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-bold);
      width: fit-content;
    }
    
    .card-title {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--color-gray-900);
      margin: 0;
    }
    
    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      font-size: var(--text-xs);
      color: var(--color-gray-600);
    }
    
    .meta-badge {
      padding: var(--space-1) var(--space-2);
      background: var(--color-gray-100);
      border-radius: var(--radius-sm);
    }
    
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }
    
    .card-tag {
      padding: var(--space-1) var(--space-3);
      background: var(--color-guide-light);
      color: var(--color-guide-primary);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }
    
    /* Message vide */
    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-gray-500);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: var(--space-4);
    }
    
    .empty-state-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-gray-700);
      margin-bottom: var(--space-2);
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .results-grid {
        grid-template-columns: 1fr;
      }
      
      .filters-container {
        flex-direction: column;
      }
      
      .search-stats {
        flex-direction: column;
        gap: var(--space-3);
      }
    }
  </style>
</head>
<body class="search-page">
  
  <div class="search-container">
    
    <!-- Header avec recherche -->
    <header class="search-header">
      <div class="search-brand">
        <a href="/">
          <span class="logo-974">M974</span>
          <span class="brand-title">Maths974</span>
        </a>
      </div>
      
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          class="search-input" 
          id="searchInput"
          placeholder="Rechercher une √©tiquette par titre, contenu, tag..."
          autocomplete="off"
        />
      </div>
      
      <div class="filters-container">
        <!-- Filtres Niveau -->
        <div class="filter-group">
          <span class="filter-label">Niveau :</span>
          {allNiveaux.map(niveau => (
            <button class="filter-tag" data-filter="niveau" data-value={niveau}>
              {niveau}
            </button>
          ))}
        </div>
        
        <!-- Filtres Th√®me -->
        <div class="filter-group">
          <span class="filter-label">Th√®me :</span>
          {allThemes.slice(0, 5).map(theme => (
            <button class="filter-tag" data-filter="theme" data-value={theme}>
              {theme}
            </button>
          ))}
        </div>
      </div>
    </header>
    
    <!-- Stats & Clear -->
    <div class="search-stats">
      <div class="stats-count">
        <strong id="resultCount">{etiquettesData.length}</strong> √©tiquettes trouv√©es
      </div>
      <button class="clear-filters" id="clearFilters">
        R√©initialiser les filtres
      </button>
    </div>
    
    <!-- R√©sultats -->
    <div class="results-grid" id="resultsGrid">
      {etiquettesData.map(etiq => (
        <a href={etiq.url} class="etiquette-card" data-etiquette={JSON.stringify(etiq)}>
          <div class="card-header">
            {etiq.id && <span class="card-id">{etiq.id}</span>}
            <h2 class="card-title">{etiq.title}</h2>
          </div>
          
          <div class="card-meta">
            {etiq.niveau && <span class="meta-badge">üìö {etiq.niveau}</span>}
            {etiq.theme && <span class="meta-badge">üìÇ {etiq.theme}</span>}
          </div>
          
          {etiq.tags.length > 0 && (
            <div class="card-tags">
              {etiq.tags.map(tag => (
                <span class="card-tag">{tag}</span>
              ))}
            </div>
          )}
        </a>
      ))}
    </div>
    
    <!-- √âtat vide -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">üîç</div>
      <h2 class="empty-state-title">Aucun r√©sultat</h2>
      <p>Essayez de modifier votre recherche ou vos filtres</p>
    </div>
    
  </div>
  
  <script is:inline define:vars={{ etiquettesData }}>
    // Donn√©es globales
    let allData = etiquettesData;
    let currentFilters = {
      search: '',
      niveau: [],
      theme: []
    };
    
    // √âl√©ments DOM
    const searchInput = document.getElementById('searchInput');
    const resultsGrid = document.getElementById('resultsGrid');
    const emptyState = document.getElementById('emptyState');
    const resultCount = document.getElementById('resultCount');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    // Fonction de filtrage
    function filterEtiquettes() {
      let filtered = allData;
      
      // Filtre recherche textuelle
      if (currentFilters.search) {
        const searchLower = currentFilters.search.toLowerCase();
        filtered = filtered.filter(e => {
          return (
            e.title.toLowerCase().includes(searchLower) ||
            e.tags.some(tag => tag.toLowerCase().includes(searchLower)) ||
            e.contenus.some(c => c.toLowerCase().includes(searchLower)) ||
            (e.sous_theme && e.sous_theme.toLowerCase().includes(searchLower))
          );
        });
      }
      
      // Filtre niveau
      if (currentFilters.niveau.length > 0) {
        filtered = filtered.filter(e => 
          currentFilters.niveau.includes(e.niveau)
        );
      }
      
      // Filtre th√®me
      if (currentFilters.theme.length > 0) {
        filtered = filtered.filter(e => 
          currentFilters.theme.includes(e.theme)
        );
      }
      
      return filtered;
    }
    
    // Afficher r√©sultats
    function displayResults() {
      const filtered = filterEtiquettes();
      
      // Mise √† jour du compteur
      resultCount.textContent = filtered.length;
      
      // Cacher tous les cards
      const allCards = resultsGrid.querySelectorAll('.etiquette-card');
      allCards.forEach(card => card.style.display = 'none');
      
      // Afficher les cards filtr√©es
      if (filtered.length === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
        
        filtered.forEach(etiq => {
          const card = Array.from(allCards).find(c => {
            const data = JSON.parse(c.dataset.etiquette);
            return data.slug === etiq.slug;
          });
          if (card) card.style.display = 'flex';
        });
      }
    }
    
    // Event: Recherche textuelle
    searchInput.addEventListener('input', (e) => {
      currentFilters.search = e.target.value;
      displayResults();
    });
    
    // Event: Filtres tags
    document.querySelectorAll('.filter-tag').forEach(btn => {
      btn.addEventListener('click', () => {
        const filterType = btn.dataset.filter;
        const value = btn.dataset.value;
        
        // Toggle active
        btn.classList.toggle('active');
        
        // Mise √† jour des filtres
        if (btn.classList.contains('active')) {
          if (!currentFilters[filterType].includes(value)) {
            currentFilters[filterType].push(value);
          }
        } else {
          currentFilters[filterType] = currentFilters[filterType].filter(v => v !== value);
        }
        
        displayResults();
      });
    });
    
    // Event: Clear filters
    clearFiltersBtn.addEventListener('click', () => {
      // Reset filtres
      currentFilters = { search: '', niveau: [], theme: [] };
      searchInput.value = '';
      
      // Reset UI
      document.querySelectorAll('.filter-tag').forEach(btn => {
        btn.classList.remove('active');
      });
      
      displayResults();
    });
    
    // Init
    displayResults();
  </script>
  
</body>
</html>