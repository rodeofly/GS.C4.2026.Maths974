---
// src/pages/recherche/index.astro
import Navbar from '../../components/Navbar.astro';
import '../../styles/main.css';
import { getCollection } from 'astro:content';

// ğŸ› ï¸ RÃ‰CUPÃ‰RATION BASE URL
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const allEtiquettes = await getCollection('guide', ({ id }) => !id.endsWith('index.md'));
const allIndex = await getCollection('guide', ({ id }) => id.endsWith('index.md'));

const etiquettesData = allEtiquettes.map(e => {
  const { data } = e;
  const sousThemeSlug = e.slug.substring(0, e.slug.lastIndexOf('/'));
  const sousTheme = allIndex.find(idx => idx.slug === sousThemeSlug);
  
  return {
    id: data.id || e.slug,
    title: data.title,
    slug: e.slug,
    niveau: data.niveau || sousTheme?.data.niveau,
    theme: data.theme || sousTheme?.data.theme,
    sous_theme: data.sous_theme || sousTheme?.data.sous_theme,
    tags: data.tags || [],
    competences: data.competences || [],
    format: data.format || '1/1',
    contenus: data.contenus || [],
    // ğŸ› ï¸ CORRECTION : Ajout de la base URL ici
    url: `${base}/guide/${e.slug}/`
  };
});

const allTags = [...new Set(etiquettesData.flatMap(e => e.tags))].sort();
const allNiveaux = [...new Set(etiquettesData.map(e => e.niveau).filter(Boolean))].sort();
const allThemes = [...new Set(etiquettesData.map(e => e.theme).filter(Boolean))].sort();
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recherche - Maths974</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body>
  
  <Navbar title="Recherche" />

  <main class="page-container">
    
    <header class="page-header">
      <h1>Moteur de Recherche</h1>
      <p>Trouvez rapidement une fiche, une dÃ©finition ou une mÃ©thode.</p>

      <div class="search-input-wrapper">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="text" 
          class="search-input" 
          id="searchInput"
          placeholder="Mots-clÃ©s, titres, tags..."
          autocomplete="off"
          autofocus
        />
      </div>

      <div class="filters-container">
        <div class="filter-group">
          <span class="filter-label">Niveau</span>
          {allNiveaux.map(niveau => (
            <button class="filter-tag" data-filter="niveau" data-value={niveau}>{niveau}</button>
          ))}
        </div>
        
        <div class="filter-group">
          <span class="filter-label">ThÃ¨me</span>
          {allThemes.slice(0, 5).map(theme => (
            <button class="filter-tag" data-filter="theme" data-value={theme}>{theme}</button>
          ))}
        </div>
      </div>
    </header>
    
    <div class="search-stats">
      <div class="stats-count">
        <strong id="resultCount">{etiquettesData.length}</strong> rÃ©sultats
      </div>
      <button class="clear-filters" id="clearFilters">RÃ©initialiser les filtres</button>
    </div>
    
    <div class="results-grid" id="resultsGrid">
      {etiquettesData.map(etiq => (
        <a href={etiq.url} class="result-card" data-etiquette={JSON.stringify(etiq)}>
          <div class="card-header">
            {etiq.id ? <span class="card-id">{etiq.id}</span> : <span></span>}
          </div>
          
          <h2 class="card-title">{etiq.title}</h2>
          
          {etiq.tags.length > 0 && (
            <div class="card-tags">
              {etiq.tags.slice(0, 3).map(tag => (
                <span class="card-tag">{tag}</span>
              ))}
            </div>
          )}

          <div class="card-meta">
            {etiq.niveau && <span class="meta-badge">ğŸ“š {etiq.niveau}</span>}
            {etiq.theme && <span class="meta-badge">ğŸ“‚ {etiq.theme}</span>}
          </div>
        </a>
      ))}
    </div>
    
    <div class="empty-state" id="emptyState" style="display: none;">
      <span class="empty-icon">ğŸ•µï¸</span>
      <h2 class="empty-title">Aucun rÃ©sultat trouvÃ©</h2>
      <p class="empty-text">Essayez de modifier vos termes de recherche ou de dÃ©sactiver les filtres.</p>
    </div>
    
  </main>
  
  <script is:inline define:vars={{ etiquettesData }}>
    let allData = etiquettesData;
    let currentFilters = { search: '', niveau: [], theme: [] };

    const searchInput = document.getElementById('searchInput');
    const resultsGrid = document.getElementById('resultsGrid');
    const emptyState = document.getElementById('emptyState');
    const resultCount = document.getElementById('resultCount');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    function filterEtiquettes() {
      let filtered = allData;
      if (currentFilters.search) {
        const searchLower = currentFilters.search.toLowerCase();
        filtered = filtered.filter(e => {
          return (
            e.title.toLowerCase().includes(searchLower) ||
            e.tags.some(tag => tag.toLowerCase().includes(searchLower)) ||
            e.contenus.some(c => c.toLowerCase().includes(searchLower)) ||
            (e.sous_theme && e.sous_theme.toLowerCase().includes(searchLower))
          );
        });
      }
      if (currentFilters.niveau.length > 0) filtered = filtered.filter(e => currentFilters.niveau.includes(e.niveau));
      if (currentFilters.theme.length > 0) filtered = filtered.filter(e => currentFilters.theme.includes(e.theme));
      return filtered;
    }
    
    function displayResults() {
      const filtered = filterEtiquettes();
      resultCount.textContent = filtered.length;
      
      const allCards = resultsGrid.querySelectorAll('.result-card'); // Updated class name
      allCards.forEach(card => card.style.display = 'none');
      
      if (filtered.length === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
        filtered.forEach(etiq => {
          // Find card by finding the link with matching href or dataset
          const card = Array.from(allCards).find(c => {
             const data = JSON.parse(c.dataset.etiquette);
             return data.slug === etiq.slug;
          });
          if (card) card.style.display = 'flex'; // Flex for flex layout inside card
        });
      }
    }
    
    searchInput.addEventListener('input', (e) => {
      currentFilters.search = e.target.value;
      displayResults();
    });

    document.querySelectorAll('.filter-tag').forEach(btn => {
      btn.addEventListener('click', () => {
        const filterType = btn.dataset.filter;
        const value = btn.dataset.value;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
           if (!currentFilters[filterType].includes(value)) currentFilters[filterType].push(value);
        } else {
          currentFilters[filterType] = currentFilters[filterType].filter(v => v !== value);
        }
        displayResults();
      });
    });

    clearFiltersBtn.addEventListener('click', () => {
      currentFilters = { search: '', niveau: [], theme: [] };
      searchInput.value = '';
      document.querySelectorAll('.filter-tag').forEach(btn => btn.classList.remove('active'));
      displayResults();
    });
    
    displayResults();
  </script>
</body>
</html>