---
const { title = "Guide de Survie" } = Astro.props;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<nav class="main-navbar no-print">
  <div class="navbar-content">
    <a href={`${base}/`} class="brand">
      <span class="logo-icon">M974</span>
      <span class="brand-text">Maths974</span>
    </a>
    
    <div class="nav-title">{title}</div>

    <div class="nav-actions">
      <a href={`${base}/recherche/`} class="nav-link nav-link-primary mobile-icon-only" title="Recherche">
        <span class="nav-icon">ğŸ”</span>
        <span class="nav-text">Recherche</span>
      </a>
      <a href={`${base}/recherche/favoris/`} class="nav-link mobile-icon-only" title="Favoris">
        <span class="nav-icon">â­</span>
        <span class="nav-text">Favoris</span>
      </a>
      
      {/* --- MENU PARAMÃˆTRES --- */}
      <div class="settings-dropdown-wrapper">
        <button id="settingsBtn" class="btn-icon" aria-label="ParamÃ¨tres d'affichage" aria-expanded="false" title="Affichage">
          âš™ï¸
        </button>
        
        <div id="settingsMenu" class="settings-menu hidden">
          <div class="menu-header">Format d'affichage</div>
          <button class="menu-item active" data-mode="screen">
            ğŸ–¥ï¸ Ã‰cran Fluide
          </button>
          <button class="menu-item" data-mode="a4">
            ğŸ“„ Format A4
          </button>
          <button class="menu-item" data-mode="a5">
            ğŸ“‘ Format A5
          </button>
        </div>
      </div>
      
      <button onclick="window.print()" class="btn-print mobile-hidden" aria-label="Imprimer cette page" title="Imprimer">
        ğŸ–¨ï¸
      </button>
    </div>
  </div>
</nav>

<script is:inline>
  // Logique de gestion des modes d'affichage
  (function() {
    const body = document.body;
    const btn = document.getElementById('settingsBtn');
    const menu = document.getElementById('settingsMenu');
    const options = document.querySelectorAll('.menu-item[data-mode]');

    // Initialisation
    const savedMode = localStorage.getItem('maths974-display-mode') || 'screen';
    setMode(savedMode);

    // --- Fonction mise Ã  jour pour gÃ©rer @page ET les tailles de police ---
    function updatePrintPageSize(mode) {
      let styleEl = document.getElementById('dynamic-page-size');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'dynamic-page-size';
        styleEl.setAttribute('media', 'print'); // S'applique uniquement Ã  l'impression
        document.head.appendChild(styleEl);
      }

      if (mode === 'a5') {
        // --- RÃ‰GLAGES POUR A5 ---
        // Texte : 10pt | H1 : 12pt
        styleEl.textContent = `
          @page { 
            size: A5 portrait; 
            margin: 0.5cm; /* Marge lÃ©gÃ¨re pour A5 */
          }
          body { 
            font-size: 10pt !important; 
          }
          h1, .etiquette-title { 
            font-size: 12pt !important; 
          }
          /* Ajustement optionnel pour les autres titres pour garder la hiÃ©rarchie */
          h2 { font-size: 11pt !important; }
          p, li { line-height: 1.4 !important; }
        `;
      } else {
        // --- RÃ‰GLAGES POUR A4 (et dÃ©faut) ---
        // Texte : 12pt | H1 : 14pt
        styleEl.textContent = `
          @page { 
            size: A4 portrait; 
            margin: 1cm; 
          }
          body { 
            font-size: 12pt !important; 
          }
          h1, .etiquette-title { 
            font-size: 14pt !important; 
          }
          h2 { font-size: 13pt !important; }
        `;
      }
    }
    // -------------------------------------------------------

    // Ouvrir/Fermer le menu
    if (btn) {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        toggleMenu(!isExpanded);
      });
    }

    // Fermer le menu si on clique ailleurs
    document.addEventListener('click', (e) => {
      if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
        toggleMenu(false);
      }
    });

    // Choix du mode
    options.forEach(opt => {
      opt.addEventListener('click', () => {
        const mode = opt.dataset.mode;
        setMode(mode);
        toggleMenu(false);
      });
    });

    function toggleMenu(show) {
      if (!menu) return;
      if (show) {
        menu.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
      } else {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    }

    function setMode(mode) {
      body.setAttribute('data-layout-mode', mode);
      localStorage.setItem('maths974-display-mode', mode);

      // On met Ã  jour l'UI du menu
      options.forEach(opt => {
        if (opt.dataset.mode === mode) opt.classList.add('active');
        else opt.classList.remove('active');
      });

      // On met Ã  jour la rÃ¨gle @page pour l'imprimante
      updatePrintPageSize(mode);
    }
  })();
</script>